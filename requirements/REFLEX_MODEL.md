# Open-Think-Reflex 需求文档

> **版本**: v1.0  
> **状态**: 草稿  
> **核心概念**: AI反射形成与衰减系统

---

## 1. 核心概念

### 1.1 大脑与反射的类比

```
人类神经系统              AI系统
─────────────────────────────────────────────
大脑（复杂思考）       AI大模型（通用智能）
  ↓                      ↓
脊髓反射（自动化）       代码/模式（快速响应）
```

**核心观点**：
- 大脑 = 大模型（慢速思考）
- 反射 = 代码/模式（快速执行）
- 反射形成需要重复强化
- 反射衰减因为不使用

---

## 2. 反射生命周期模型

### 2.1 七阶段模型

```
建立印象 ──► 强化 ──► 达成阈值 ──► 初步反射 ──► 加强
                │                                    │
                │                                    ▼
                │                             【反射形成区】
                │                                    │
                │                                    ▼
                │                              深度反射（永久）
                │
                ▼
         不用 → 降级 → 丧失
```

### 2.2 各阶段特征

| 阶段 | 强度 | 感知 | 可逆性 |
|------|------|------|--------|
| 建立印象 | 10% | 强 | 易 |
| 强化 | 30% | 中 | 可逆 |
| 达成阈值 | 50% | 弱 | 尚可 |
| 初步反射 | 70% | 无 | 可逆 |
| 加强 | 85% | 无 | 难 |
| 深度反射 | 100% | 无 | 极难 |
| 衰减 | ↓ | 弱 | 可逆 |
| 丧失 | 0% | 强 | 重新开始 |

### 2.3 衰减公式

```
Strength(t) = Strength_initial × e^(-λ × t)

其中：
- λ = 衰减常数（因反射类型而异）
- t = 距离上次强化的时间
```

---

## 3. 功能需求

### 3.1 核心功能

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 对话中建立反射 | 从对话中提取和存储模式 | P0 |
| 反射匹配 | 匹配用户输入与已有反射 | P0 |
| 反射树展示 | 可视化展示反射路径 | P1 |
| 用户选择 | 手动或自动选择反射路径 | P1 |
| 反射衰减 | 自动衰减不使用的反射 | P2 |

### 3.2 反射存储

```typescript
interface Pattern {
  id: string;                    // 唯一标识
  trigger: string;                 // 触发词
  response: string;               // 响应路径
  strength: number;              // 强度 0-100
  threshold: number;             // 激活阈值
  connections: string[];         // 关联反射
  metadata: {
    created: number;
    updated: number;
    reinforcementCount: number;
    decayCount: number;
  };
}
```

---

## 4. 用户故事

### 4.1 建立反射

```
作为用户，我想让AI学习我的偏好，
所以它能按我的方式响应。

场景1：直接纠正
给定：反射强度30
当我：纠正AI响应
那么：反射强度增加10
并且：我可以看到更新后的强度

场景2：多次纠正
给定：同一反射纠正4次
当：强度达到70
那么：跨越阈值
并且：AI开始自动应用
```

### 4.2 展示反射树

```
作为用户，我想看到已建立的反射，
所以我能理解AI学到了什么。

验收标准：
- CLI命令显示反射树
- 反射以树状结构展示
- 每个反射显示强度指示
- 阈值线可见
- 活跃反射高亮
- 潜伏反射淡化
```

### 4.3 选择反射路径

```
作为用户，我想选择应用的反射路径，
所以我能指导AI的响应。

场景1：手动选择
给定：3个匹配反射（85、72、45分）
当：我查看反射树
那么：我看到所有反射按分数排序
并且：我可以选择任意一个
并且：AI应用我选择的反射

场景2：自动选择
给定：反射分数92（高于阈值）
当：我给出匹配输入
那么：AI自动应用
并且：我看到自动选择通知
```

---

## 5. 反射树示例

```
用户输入: "写个用户API"

匹配反射:
└── user_api
    ├── pagination (分页) ────── 85%
    │   └── pageSize, pageNum
    ├── response (响应) ───── 70%
    │   └── code, message, data
    ├── error (错误) ────── 60%
    │   └── errorCode, errorMsg
    └── logging (日志) ───── 50%
        └── logLevel, logPath

用户可以:
- 选择路径 (/pagination + /response)
- 修改权重
- 添加新反射分支
```

---

## 6. 技术设计

### 6.1 系统架构

```
┌─────────────────────────────────────────┐
│             CLI Interface                │
│  (Shell / Terminal / API / Web)        │
└──────────────────┬────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│              Core Engine                  │
│  ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │ Stimulus │ │Perception│ │Activate│ │
│  │Processor│ │  Engine  │ │ Engine │ │
│  └──────────┘ └──────────┘ └────────┘ │
└──────────────────┬────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│            Storage Backend              │
│  (JSON / SQLite / Vector / Graph)    │
└─────────────────────────────────────────┘
```

### 6.2 核心接口

```typescript
// 反射处理器
interface PatternProcessor {
  extract(stimulus: string): PatternCandidate[];
  match(input: string): MatchResult[];
  reinforce(patternId: string, delta: number): void;
}

// 匹配结果
interface MatchResult {
  patternId: string;
  score: number;        // 0-100
  matchedElement: string;
  path: string[];
}
```

---

## 7. 存储设计

### 7.1 支持的后端

| 后端 | 适用场景 | 优势 |
|------|----------|------|
| JSON | 简单、小规模 | 可读性好、版本控制 |
| SQLite | 中等规模 | 查询、事务 |
| Vector DB | 语义匹配 | 快速相似度搜索 |
| Graph DB | 关系复杂 | 关系遍历 |

### 7.2 数据结构

```json
{
  "patterns": [
    {
      "id": "user_api_pagination",
      "trigger": "用户API",
      "response": "/api/users?pageSize=10&pageNum=1",
      "strength": 85,
      "threshold": 50,
      "connections": ["user_api_response", "user_api_error"],
      "metadata": {
        "created": 1700000000,
        "updated": 1700100000,
        "reinforcementCount": 5
      }
    }
  ],
  "connections": [
    {
      "source": "user_api_pagination",
      "target": "user_api_response",
      "type": "sequential"
    }
  ]
}
```

---

## 8. 用户交互

### 8.1 CLI命令

```bash
# 查看反射树
otr tree

# 添加反射
otr add "触发词" "响应路径"

# 测试匹配
otr match "输入文本"

# 查看反射状态
otr status

# 手动强化
otr reinforce <id> +10

# 导出反射
otr export patterns.json
```

### 8.2 交互流程

```
1. 用户输入
2. CLI拦截 → 匹配反射
3. 显示匹配树（带分数）
4. 用户选择或自动应用
5. 输出给AI
6. 收集反馈 → 强化反射
```

---

## 9. 衰减机制

### 9.1 衰减规则

| 反射类型 | 衰减常数(λ) | 说明 |
|----------|--------------|------|
| 短期反射 | 0.1/天 | 快速衰减 |
| 中期反射 | 0.01/天 | 中等衰减 |
| 长期反射 | 0.001/天 | 缓慢衰减 |
| 永久反射 | 0 | 不衰减 |

### 9.2 衰减曲线

```
强度
100% │ 深度反射 ────────────────┐
     │                             │
 85% │ 加强 ────────┐              │
     │              │ 衰减曲线    │
 70% │ 初步反射 ──┤              │
     │              │              │
 50% │ 阈值 ──────┤              │
     │              │              │
 30% │ 强化 ──────┤              │
     │              │              │
 10% │ 建立 ──────┘              │
     │                             │
  0% └──────────────────┴──────────→ 时间
       0    7天   14天   30天
```

---

## 10. 应用场景

### 10.1 Chatbot偏好学习

```
用户总是要简洁回复
↓
建立印象（用户说"简洁点"）
↓
强化（提醒2-3次）
↓
达成阈值（5次）
↓
初步反射（AI自动简洁回复）
↓
加强（持续简洁）
↓
深度反射（永远简洁）
```

### 10.2 代码审查助手

```
团队想要camelCase变量名
↓
审查者纠正1次（建立印象）
↓
审查者纠正3次（强化）
↓
5次纠正（达成阈值）
↓
AI自动检查camelCase（初步反射）
↓
持续使用（加强）
↓
深度反射（团队永远记住）
```

---

## 11. 未来展望

### 11.1 理想状态

```
用户说"做X"
AI（自动反射）→ 执行X

不需要：
- 每次解释怎么做X
- 重复纠正同样错误
- 提醒AI偏好
```

### 11.2 长期目标

1. **零指令执行**
   - AI从最小线索学习用户意图
   - 不需要显式指令

2. **主动协助**
   - AI预测用户需求
   - 自动触发反射

3. **个性化智能**
   - 每个用户发展独特的反射集
   - AI成为个性化助手

---

## 12. 文档索引

| 文档 | 内容 |
|------|------|
| REFLEX_MODEL.md | 核心概念和生命周期模型 |
| 02-PROTOCOL.md | 协议接口设计（技术） |
| 03-USER_STORIES.md | 用户故事和交互流程（用户视角） |
| 04-ARCHITECTURE.md | 系统架构和技术实现（技术） |

---

**文档版本**: v1.0  
**创建时间**: 2026-02-20  
**项目**: open-think-reflex
